name: Deploy to Production

on:
  # ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ - Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  # push:
  #   branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        # Note: Context access warnings are expected when secrets are not yet configured
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          if [ -z "$HOST" ]; then
            echo "âŒ HOST secret is not set"
            exit 1
          fi
          if [ -z "$USERNAME" ]; then
            echo "âŒ USERNAME secret is not set"
            exit 1
          fi
          if [ -z "$PRIVATE_KEY" ]; then
            echo "âŒ PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        # Note: Context access warnings are expected when secrets are not yet configured
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT || '22' }}
          timeout: 30s
          command_timeout: 10m
          script_stop: true
          script: |
            set -e
            
            echo "ğŸš€ Starting deployment to production..."
            echo "ğŸ“ Server: [CONFIGURED]"
            echo "ğŸ‘¤ User: [CONFIGURED]"
            echo "â° Time: $(date)"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
            if [ ! -d "/var/www/frontend_axenta" ]; then
              echo "âŒ Directory /var/www/frontend_axenta does not exist"
              exit 1
            fi
            
            cd /var/www/frontend_axenta
            
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
            echo "ğŸ“ Current commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Git Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
            if [ ! -d ".git" ]; then
              echo "âŒ Not a git repository"
              exit 1
            fi
            
            # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Git
            echo "âš™ï¸ Configuring Git..."
            git config pull.rebase false
            git config --global --add safe.directory $(pwd)
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±ÑĞºĞ°Ğ¿ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
            echo "ğŸ’¾ Creating backup..."
            BACKUP_DIR="/tmp/frontend_backup_$(date +%Y%m%d_%H%M%S)"
            cp -r . "$BACKUP_DIR" || echo "âš ï¸ Backup creation failed, continuing..."
            
            # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            echo "ğŸ“¥ Fetching changes..."
            git fetch --all --prune
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/main)
            
            if [ "$LOCAL" != "$REMOTE" ]; then
              echo "ğŸ”„ Updating from $LOCAL to $REMOTE"
              git reset --hard origin/main
              echo "âœ… Repository updated successfully"
            else
              echo "âœ… Repository is already up to date"
            fi
            
            echo "ğŸ“ Updated to commit: $(git rev-parse --short HEAD)"
            echo "ğŸ“ Commit message: $(git log -1 --pretty=%B)"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ package.json
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json not found"
              exit 1
            fi
            
            # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°
            echo "âš™ï¸ Setting up production environment..."
            if [ -f ".env.production" ]; then
              echo "âœ… Using existing .env.production"
            else
              echo "ğŸ“ Creating .env.production from template..."
              cat > .env.production << 'ENVEOF'
            # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Axenta Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°
            VITE_BACKEND_URL=https://api.axenta.glonass-saratov.ru
            VITE_WS_BASE_URL=wss://api.axenta.glonass-saratov.ru
            VITE_APP_NAME=Axenta CRM
            VITE_API_VERSION=v1
            VITE_APP_ENV=production
            VITE_API_TIMEOUT=10000
            ENVEOF
            fi
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
            echo "ğŸ“¦ Installing dependencies..."
            if command -v npm >/dev/null 2>&1; then
              npm ci --production=false
            else
              echo "âŒ npm not found"
              exit 1
            fi
            
            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸
            echo "ğŸ—ï¸ Building project for production..."
            npm run build:production
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑĞ±Ğ¾Ñ€ĞºĞ¸
            if [ ! -d "dist" ]; then
              echo "âŒ Build failed - dist directory not found"
              exit 1
            fi
            
            echo "âœ… Build completed successfully"
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ nginx
            echo "ğŸ”„ Reloading nginx..."
            if command -v systemctl >/dev/null 2>&1; then
              sudo systemctl reload nginx
              echo "âœ… Nginx reloaded successfully"
            else
              echo "âš ï¸ systemctl not found, skipping nginx reload"
            fi
            
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸ“Š Deployment summary:"
            echo "   - Repository: frontend_axenta"
            echo "   - Branch: main"
            echo "   - Commit: $(git rev-parse --short HEAD)"
            echo "   - Time: $(date)"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs and fix any issues before retrying."
