name: Safe Deploy Frontend

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment (only if secrets are configured)'
        required: false
        default: false
        type: boolean

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.check.outputs.can-deploy }}
    steps:
      - name: Check if deployment is possible
        id: check
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          echo "🔍 Checking deployment prerequisites..."
          
          if [[ -n "$HOST" && -n "$USERNAME" && -n "$PRIVATE_KEY" ]]; then
            echo "✅ All required secrets are configured"
            echo "can-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Required secrets are missing"
            echo "📋 Missing secrets:"
            [[ -z "$HOST" ]] && echo "   • HOST"
            [[ -z "$USERNAME" ]] && echo "   • USERNAME"
            [[ -z "$PRIVATE_KEY" ]] && echo "   • PRIVATE_KEY"
            echo ""
            echo "🔧 Configure secrets at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "can-deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: check-secrets
    runs-on: ubuntu-latest
    if: needs.check-secrets.outputs.can-deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT || '22' }}
          script_stop: true
          script: |
            set -e
            cd /var/www/frontend_axenta
            
            echo "🔧 Starting safe deployment..."
            echo "📍 Working directory: $(pwd)"
            echo "📍 Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
            
            # Обновляем репозиторий
            echo "📥 Updating repository..."
            git fetch --all --prune
            git pull origin main
            
            # Устанавливаем зависимости
            echo "📦 Installing dependencies..."
            npm ci --production=false
            
            # Собираем проект
            echo "🏗️ Building project..."
            npm run build
            
            # Перезагружаем веб-сервер
            echo "🔄 Reloading web server..."
            sudo systemctl reload nginx
            
            echo "🎉 Safe deployment completed successfully!"

  notify-skip:
    needs: check-secrets
    runs-on: ubuntu-latest
    if: needs.check-secrets.outputs.can-deploy == 'false'
    steps:
      - name: Notify about skipped deployment
        run: |
          echo "⚠️ Deployment was skipped due to missing secrets"
          echo ""
          echo "🎉 Your code changes are safely stored in GitHub!"
          echo ""
          echo "📋 To enable deployment, configure these secrets:"
          echo "   • HOST - Server IP or domain"
          echo "   • USERNAME - SSH username"
          echo "   • PRIVATE_KEY - SSH private key"
          echo ""
          echo "🔧 Add secrets at: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "📖 See documentation: GITHUB_SECRETS_SETUP.md"