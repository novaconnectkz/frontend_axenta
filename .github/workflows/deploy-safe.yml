name: Safe Deploy Frontend

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment (only if secrets are configured)'
        required: false
        default: false
        type: boolean

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.check.outputs.can-deploy }}
    steps:
      - name: Check if deployment is possible
        id: check
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          echo "ğŸ” Checking deployment prerequisites..."
          
          if [[ -n "$HOST" && -n "$USERNAME" && -n "$PRIVATE_KEY" ]]; then
            echo "âœ… All required secrets are configured"
            echo "can-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Required secrets are missing"
            echo "ğŸ“‹ Missing secrets:"
            [[ -z "$HOST" ]] && echo "   â€¢ HOST"
            [[ -z "$USERNAME" ]] && echo "   â€¢ USERNAME"
            [[ -z "$PRIVATE_KEY" ]] && echo "   â€¢ PRIVATE_KEY"
            echo ""
            echo "ğŸ”§ Configure secrets at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "can-deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: check-secrets
    runs-on: ubuntu-latest
    if: needs.check-secrets.outputs.can-deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT || '22' }}
          script_stop: true
          script: |
            set -e
            cd /var/www/frontend_axenta
            
            echo "ğŸ”§ Starting safe deployment..."
            echo "ğŸ“ Working directory: $(pwd)"
            echo "ğŸ“ Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
            echo "ğŸ“¥ Updating repository..."
            git fetch --all --prune
            git pull origin main
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --production=false
            
            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
            echo "ğŸ—ï¸ Building project..."
            npm run build
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²ĞµĞ±-ÑĞµÑ€Ğ²ĞµÑ€
            echo "ğŸ”„ Reloading web server..."
            sudo systemctl reload nginx
            
            echo "ğŸ‰ Safe deployment completed successfully!"

  notify-skip:
    needs: check-secrets
    runs-on: ubuntu-latest
    if: needs.check-secrets.outputs.can-deploy == 'false'
    steps:
      - name: Notify about skipped deployment
        run: |
          echo "âš ï¸ Deployment was skipped due to missing secrets"
          echo ""
          echo "ğŸ‰ Your code changes are safely stored in GitHub!"
          echo ""
          echo "ğŸ“‹ To enable deployment, configure these secrets:"
          echo "   â€¢ HOST - Server IP or domain"
          echo "   â€¢ USERNAME - SSH username"
          echo "   â€¢ PRIVATE_KEY - SSH private key"
          echo ""
          echo "ğŸ”§ Add secrets at: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "ğŸ“– See documentation: GITHUB_SECRETS_SETUP.md"