name: Deploy Frontend (Simple)

on:
  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤
  # push:
  #   branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deployment secrets
        id: check-secrets
        run: |
          echo "üîç Checking deployment configuration..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
          SECRETS_CONFIGURED=true
          
          if [ -z "${{ secrets.HOST }}" ]; then
            echo "‚ùå HOST secret is missing"
            SECRETS_CONFIGURED=false
          fi
          
          if [ -z "${{ secrets.USERNAME }}" ]; then
            echo "‚ùå USERNAME secret is missing"
            SECRETS_CONFIGURED=false
          fi
          
          if [ -z "${{ secrets.PRIVATE_KEY }}" ]; then
            echo "‚ùå PRIVATE_KEY secret is missing"
            SECRETS_CONFIGURED=false
          fi
          
          if [ "$SECRETS_CONFIGURED" = "false" ]; then
            echo ""
            echo "‚ö†Ô∏è Deployment secrets are not configured!"
            echo ""
            echo "üéâ Code changes have been successfully pushed to GitHub!"
            echo ""
            echo "üìã To enable deployment, configure these GitHub Secrets:"
            echo "   ‚Ä¢ HOST - Your server IP address or domain"
            echo "   ‚Ä¢ USERNAME - SSH username for server access"
            echo "   ‚Ä¢ PRIVATE_KEY - SSH private key content"
            echo "   ‚Ä¢ PORT - SSH port (optional, defaults to 22)"
            echo ""
            echo "üîß Configure secrets at:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "üìñ For detailed instructions, see GITHUB_SECRETS_SETUP.md"
            echo ""
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "‚úÖ All deployment secrets are configured"
            echo "üöÄ Proceeding with deployment..."
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSH
        if: steps.check-secrets.outputs.should_deploy == 'true' && secrets.HOST != '' && secrets.USERNAME != '' && secrets.PRIVATE_KEY != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT || '22' }}
          script_stop: true
          script: |
            set -e
            cd /var/www/frontend_axenta
            
            echo "üîß Starting deployment process..."
            echo "üìç Current directory: $(pwd)"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• Fetching latest changes..."
            git fetch --all --prune
            git pull origin main
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ Installing dependencies..."
            npm install
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "üèóÔ∏è Building project..."
            npm run build
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
            echo "üîÑ Reloading nginx..."
            sudo systemctl reload nginx
            
            echo "üéâ Deployment completed successfully!"
