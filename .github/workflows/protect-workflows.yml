name: Protect Workflows Directory

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'

jobs:
  check-workflow-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            .github/workflows/**
      
      - name: Check if workflows were modified
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ .github/workflows/"
          echo ""
          echo "üö´ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–∞–ø–∫–µ .github/workflows –∑–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!"
          echo ""
          echo "üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "  - $file"
          done
          echo ""
          echo "üîß –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã:"
          echo "  1. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –ø—Ä–æ–µ–∫—Ç–∞"
          echo "  2. –°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π issue —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          echo "  3. –ü–æ–ª—É—á–∏—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
          echo ""
          echo "‚ö†Ô∏è  –î–∞–Ω–Ω—ã–π pull request –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–æ–±—Ä–µ–Ω–∏—è."
          exit 1
      
      - name: Success message
        if: steps.changed-files.outputs.any_changed == 'false'
        run: |
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ .github/workflows –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ!"

  require-admin-approval:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, '.github/workflows')
    steps:
      - name: Check if user is admin
        uses: actions/github-script@v7
        with:
          script: |
            const { data: user } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            
            if (user.permission !== 'admin' && user.permission !== 'write') {
              core.setFailed('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å .github/workflows');
            } else {
              console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
            }
      
      - name: Add protection comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üö´ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ .github/workflows –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã

### ‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–∞–ø–∫–µ \`.github/workflows/\` –∑–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

### üîß –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
1. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É** –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–æ–±—Ä–µ–Ω–∏—è
2. **–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É** –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. **–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è** –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

### üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | sed 's/^/- /')

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
Workflow —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∫–æ–¥ –∏ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ä–µ—Ç–∞–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ü–æ—ç—Ç–æ–º—É –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è.

---
*–≠—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π –∑–∞—â–∏—Ç—ã workflows.*`
            })
