# Интерфейс биллинга Axenta CRM

## Обзор

Интерфейс биллинга предоставляет полнофункциональное решение для управления тарифными планами, подписками, счетами и настройками биллинга в Axenta CRM.

## Основные возможности

### ✅ 1. Статистический дашборд

- **Виджеты с ключевыми метриками:**
  - Общий доход компании
  - Доход за текущий месяц
  - Сумма к оплате
  - Просроченные платежи
  - Количество активных подписок
  - Количество просроченных счетов

### ✅ 2. Управление тарифными планами

- **CRUD операции:**

  - Создание новых тарифных планов
  - Редактирование существующих планов
  - Удаление планов (с проверкой активных подписок)
  - Просмотр списка всех планов

- **Возможности планов:**

  - Настройка цены и валюты
  - Выбор периода биллинга (месячный/годовой/разовый)
  - Лимиты устройств, пользователей, хранилища
  - Дополнительные функции (аналитика, API, поддержка, домен)
  - Статус активности и популярности

- **Фильтрация и поиск:**
  - Поиск по названию плана
  - Фильтрация по статусу (активные/неактивные)

### ✅ 3. Управление подписками

- **Функциональность:**

  - Создание подписок для компаний
  - Привязка к тарифным планам
  - Управление статусом подписки
  - Настройка автопродления
  - Отслеживание дат платежей

- **Статусы подписок:**
  - Активная
  - Истекшая
  - Отмененная
  - Приостановленная

### ✅ 4. Управление счетами

- **Просмотр счетов:**

  - Список всех счетов компании
  - Детальная информация по каждому счету
  - Позиции счета с количеством и ценами
  - Финансовая информация (НДС, итого, оплачено)

- **Обработка платежей:**

  - Различные способы оплаты
  - Частичные и полные платежи
  - Примечания к платежам
  - Автоматическое обновление статуса

- **Управление счетами:**

  - Отмена счетов с указанием причины
  - Фильтрация по статусу и датам
  - Индикация просроченных счетов

- **Статусы счетов:**
  - Черновик
  - Отправлен
  - Частично оплачен
  - Оплачен
  - Просрочен
  - Отменен

### ✅ 5. Настройки биллинга

- **Генерация счетов:**

  - Автоматическая генерация
  - День месяца для генерации
  - Срок оплаты в днях

- **Налоги и валюта:**

  - Ставка НДС
  - НДС включен/не включен в цену
  - Валюта по умолчанию

- **Уведомления:**

  - Уведомления перед выставлением счета
  - Уведомления перед сроком оплаты
  - Уведомления о просрочке

- **Льготные тарифы:**
  - Включение льгот для неактивных объектов
  - Настройка коэффициента льготы
  - Разрешение частичных платежей

## Архитектура

### Компоненты

#### 1. Типы TypeScript (`src/types/billing.ts`)

Полная система типов для всех биллинговых данных:

```typescript
// Основные типы
export interface BillingPlan { ... }
export interface Subscription { ... }
export interface Invoice { ... }
export interface BillingSettings { ... }

// Типы для API
export interface BillingDashboardData { ... }
export interface BillingCalculation { ... }
export interface BillingStatistics { ... }

// Типы для форм
export interface CreateBillingPlanData { ... }
export interface ProcessPaymentData { ... }
```

#### 2. Сервис API (`src/services/billingService.ts`)

Централизованный сервис для работы с биллинговым API:

```typescript
class BillingService {
  // Тарифные планы
  async getBillingPlans(): Promise<BillingPlan[]>;
  async createBillingPlan(data: CreateBillingPlanData): Promise<BillingPlan>;

  // Подписки
  async getSubscriptions(companyId: number): Promise<Subscription[]>;
  async createSubscription(data: CreateSubscriptionData): Promise<Subscription>;

  // Счета
  async getInvoices(
    filter?: InvoicesFilter
  ): Promise<{ invoices: Invoice[]; total: number }>;
  async processPayment(
    invoiceId: number,
    data: ProcessPaymentData
  ): Promise<Invoice>;

  // Настройки
  async getBillingSettings(companyId: number): Promise<BillingSettings>;
  async updateBillingSettings(
    companyId: number,
    data: UpdateBillingSettingsData
  ): Promise<BillingSettings>;

  // Дашборд
  async getBillingDashboardData(
    companyId: number
  ): Promise<BillingDashboardData>;
}
```

#### 3. Главный компонент (`src/views/Billing.vue`)

Vue компонент с четырьмя вкладками:

- **Тарифные планы** - управление планами
- **Подписки** - управление подписками компаний
- **Счета** - просмотр и обработка счетов
- **Настройки** - конфигурация биллинга

### Особенности реализации

#### 1. Мультитенантность

- Автоматическое добавление заголовка `X-Tenant-ID`
- Изоляция данных по компаниям
- Контекстная фильтрация данных

#### 2. Авторизация

- Автоматическое добавление JWT токенов
- Перенаправление на страницу входа при ошибках авторизации
- Проверка прав доступа через роутинг

#### 3. Обработка ошибок

- Централизованная обработка ошибок API
- Пользовательские уведомления
- Логирование ошибок в консоль

#### 4. Производительность

- Ленивая загрузка данных по вкладкам
- Debounced поиск и фильтрация
- Кэширование данных компании

## Использование

### Навигация

Страница биллинга доступна по маршруту `/billing` и требует авторизации с правом `billing.view`.

### Основные сценарии

#### 1. Создание тарифного плана

1. Перейти на вкладку "Тарифные планы"
2. Нажать кнопку "Добавить план"
3. Заполнить форму с основными параметрами
4. Настроить лимиты и возможности
5. Сохранить план

#### 2. Создание подписки

1. Перейти на вкладку "Подписки"
2. Нажать кнопку "Создать подписку"
3. Выбрать тарифный план
4. Указать параметры подписки
5. Сохранить подписку

#### 3. Обработка платежа

1. Перейти на вкладку "Счета"
2. Найти нужный счет
3. Нажать на меню действий
4. Выбрать "Оплатить"
5. Указать сумму и способ оплаты
6. Обработать платеж

#### 4. Настройка льготных тарифов

1. Перейти на вкладку "Настройки"
2. Включить "Льготы для неактивных объектов"
3. Установить коэффициент льготы (например, 0.5 для 50% скидки)
4. Сохранить настройки

## Интеграция с backend

Интерфейс полностью интегрирован с существующим backend API биллинга:

- **Эндпоинты тарифных планов:** `/api/billing-plans/*`
- **Эндпоинты подписок:** `/api/subscriptions/*`
- **Эндпоинты счетов:** `/api/billing/invoices/*`
- **Эндпоинты настроек:** `/api/billing/settings`
- **Эндпоинты статистики:** `/api/billing/statistics`

## Тестирование

### E2E тесты

Комплексные тесты в `src/__tests__/billing.e2e.test.ts` покрывают:

- Инициализацию страницы и загрузку данных
- Управление тарифными планами
- Управление подписками
- Обработку счетов и платежей
- Настройки биллинга
- Фильтрацию и поиск
- Обработку ошибок

### Запуск тестов

```bash
npm run test:unit src/__tests__/billing.e2e.test.ts
```

## Безопасность

- Все запросы требуют JWT авторизации
- Мультитенантная изоляция данных
- Валидация прав доступа
- Безопасное хранение токенов

## Производительность

- Ленивая загрузка компонентов
- Debounced поиск (300ms)
- Параллельная загрузка данных
- Оптимизированные API запросы
- Кэширование настроек

## Совместимость

- Vue 3 + Composition API
- Vuetify 3 для UI компонентов
- TypeScript для типизации
- Vitest для тестирования
- Axios для HTTP запросов

## Будущие улучшения

- Графики и аналитика доходов
- Экспорт отчетов в PDF/Excel
- Настройка автоматических уведомлений
- Интеграция с платежными системами
- Календарь планирования платежей
