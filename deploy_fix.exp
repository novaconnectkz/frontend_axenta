#!/usr/bin/expect -f

set timeout 60
set server "194.87.143.169"
set username "root"
set password "g-t+XM#3an2YJM"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
spawn ssh -o StrictHostKeyChecking=no $username@$server

# –û–∂–∏–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        # –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
        send "echo 'üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π backend —Å –Ω–æ–≤—ã–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏...'\r"
        expect "# "
        
        send "cd /var/www/app/backend_axenta\r"
        expect "# "
        
        send "echo 'üìã –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:' && git log --oneline -3\r"
        expect "# "
        
        send "echo 'üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub...'\r"
        expect "# "
        
        send "git fetch --all\r"
        expect "# "
        
        send "git pull origin main\r"
        expect "# "
        
        send "echo 'üìã –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:' && git log --oneline -3\r"
        expect "# "
        
        send "echo 'üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é...'\r"
        expect "# "
        
        send "go build -o axenta_backend_new .\r"
        expect "# "
        
        send "echo 'üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏...'\r"
        expect "# "
        
        send "cp axenta_backend axenta_backend_backup_\$(date +%Y%m%d_%H%M%S)\r"
        expect "# "
        
        send "echo 'üîÑ –ó–∞–º–µ–Ω—è–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª...'\r"
        expect "# "
        
        send "mv axenta_backend_new axenta_backend\r"
        expect "# "
        
        send "chmod +x axenta_backend\r"
        expect "# "
        
        send "echo 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å...'\r"
        expect "# "
        
        send "systemctl restart axenta-backend\r"
        expect "# "
        
        send "sleep 3\r"
        expect "# "
        
        send "echo 'üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞...'\r"
        expect "# "
        
        send "systemctl status axenta-backend --no-pager -l\r"
        expect "# "
        
        send "echo 'üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç...'\r"
        expect "# "
        
        send "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/api/accounts || echo '–¢–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è'\r"
        expect "# "
        
        send "echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!'\r"
        expect "# "
        
        send "exit\r"
    }
    timeout {
        puts "Timeout –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏"
        exit 1
    }
    eof {
        puts "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ"
        exit 1
    }
}

expect eof
