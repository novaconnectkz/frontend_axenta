#!/usr/bin/expect -f

set timeout 120
set server "194.87.143.169"
set username "root"
set password "g-t+XM#3an2YJM"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
spawn ssh -o StrictHostKeyChecking=no $username@$server

# –û–∂–∏–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        # –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π
        send "echo 'üöÄ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã –∏ –¥–µ–ø–ª–æ–∏–º backend...'\r"
        expect "# "
        
        send "cd /var/www/app/backend_axenta\r"
        expect "# "
        
        send "echo 'üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ Git...'\r"
        expect "# "
        
        send "git config --global --add safe.directory /var/www/app/backend_axenta\r"
        expect "# "
        
        send "echo 'üìã –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:' && git log --oneline -3\r"
        expect "# "
        
        send "echo 'üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub...'\r"
        expect "# "
        
        send "git fetch --all\r"
        expect "# "
        
        send "git reset --hard origin/main\r"
        expect "# "
        
        send "echo 'üìã –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:' && git log --oneline -3\r"
        expect "# "
        
        send "echo 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ handlers/accounts.go...'\r"
        expect "# "
        
        send "ls -la handlers/accounts.go\r"
        expect "# "
        
        send "echo 'üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (–æ—Ç–∫–ª—é—á–∞–µ–º VCS)...'\r"
        expect "# "
        
        send "go build -buildvcs=false -o axenta_backend_new .\r"
        expect "# "
        
        send "echo '‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–±–æ—Ä–∫–∞ —Å–æ–∑–¥–∞–ª–∞—Å—å...'\r"
        expect "# "
        
        send "ls -la axenta_backend_new\r"
        expect "# "
        
        send "echo 'üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏...'\r"
        expect "# "
        
        send "cp axenta_backend axenta_backend_backup_\$(date +%Y%m%d_%H%M%S)\r"
        expect "# "
        
        send "echo 'üîÑ –ó–∞–º–µ–Ω—è–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª...'\r"
        expect "# "
        
        send "mv axenta_backend_new axenta_backend\r"
        expect "# "
        
        send "chmod +x axenta_backend\r"
        expect "# "
        
        send "echo 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å...'\r"
        expect "# "
        
        send "systemctl restart axenta-backend\r"
        expect "# "
        
        send "sleep 5\r"
        expect "# "
        
        send "echo 'üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞...'\r"
        expect "# "
        
        send "systemctl status axenta-backend --no-pager -l | head -20\r"
        expect "# "
        
        send "echo 'üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç...'\r"
        expect "# "
        
        send "curl -s -w 'HTTP Status: %{http_code}\\n' http://localhost:8080/api/accounts\r"
        expect "# "
        
        send "echo 'üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ accounts —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤...'\r"
        expect "# "
        
        send "journalctl -u axenta-backend --no-pager -n 20 | grep -i accounts || echo 'Accounts —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö'\r"
        expect "# "
        
        send "echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!'\r"
        expect "# "
        
        send "exit\r"
    }
    timeout {
        puts "Timeout –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏"
        exit 1
    }
    eof {
        puts "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ"
        exit 1
    }
}

expect eof
